matrix:
  snap_version:
    - 1.18/edge
    - 1.17/edge
    - 1.17/stable
    - 1.16/edge
    - 1.15/edge
  series:
    - focal
    - bionic
    - xenial
  channel:
    - edge
    - stable
  arch:
    - amd64
    - arm64

vars:
  juju_deploy_bundle: cs:~containers/charmed-kubernetes
  juju_deploy_channel: {{channel}}
  juju_cloud: aws/us-east-1
  juju_controller: validate-ck-{{series}}
  juju_model: validate-model

backends: [juju/mem=16G,cores=16,root-disk=100G]

provisioner:
  shell: |
    rsync -avz files/files* ubuntu@1.2.3.4:.
    sudo apt-get remove lxd lxd-client
    sudo snap install juju --classic

plan: |
  #!/bin/bash
  set -x

  if ! juju destroy-controller -y --destroy-all-models --destroy-storage {{juju_controller}} 2>&1; then
    juju kill-controller -y {{juju_controller}} 2>&1
  fi

  juju bootstrap {{juju_cloud}} {{juju_controller}} \
       -d {{juju_model}} \
       --bootstrap-series {{series}} \
       --force \
       --bootstrap-constraints 'arch={{arch}}' \
       {% if series == 'focal' %}
       --model-default image-stream=daily \
       {% endif %}
       --model-default test-mode=true \
       --model-default resource-tags=owner=k8sci

  tee overlay.yaml <<EOF
  applications:
    kubernetes-master:
      options:
        channel: {{snap_version}}
    kubernetes-worker:
      options:
        channel: {{snap_version}}
  EOF

  juju deploy -m {{juju_controller}}:{{juju_model}} \
        --series {{series}} \
        --force \
        --overlay overlay.yaml \
        --channel {{juju_deploy_channel}} {{juju_deploy_bundle}}

  juju-wait -e {{juju_controller}}:{{juju_model}} -w

  pytest -m "not slow" jobs/integration/validation.py \
     --cloud {{juju_cloud}} \
     --model {{juju_model}} \
     --controller {{juju_controller}}


meta:
  name: Verify CK
  synopsis:
    - summary: Running the base validation suite against a deployed Kubernetes
      code: |
        ```
        # edit spec.yml and update the appropriate vars under the `env:` section
        > ogc --spec jobs/validate/spec.yml -t core
        ```
  description: |
    Verifies that CK passes integration tests
  mkdocs:
    destination:
      - "validations/ck/index.md"
    jenkins-job-builder:
      jobs:
        - jobs/ci-master.yaml
        - jobs/validate.yaml
